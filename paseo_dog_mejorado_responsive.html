<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PaseoDog - Sistema Completo</title>
  <meta name="description" content="PaseoDog - GestiÃ³n profesional de paseos. Panel admin, perfil, historial y galerÃ­as.">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind Config: custom colors and radius -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#10b981',
            primaryDark: '#059669',
            accent: '#6366f1',
          },
          borderRadius:{
            xl:'1rem',
            '2xl':'1.5rem'
          },
          boxShadow:{
            soft:'0 4px 20px rgba(0,0,0,0.08)',
            card:'0 6px 26px rgba(0,0,0,0.12)'
          }
        }
      }
    }
  </script>

  <style>
/* Tailwind migration stage 1: all custom CSS removed except minimal fixes.
   Now the HTML uses Tailwind utility classes for layout, spacing, colors and UI.
   Next steps will progressively replace all remaining structural classes.
*/
</style>
</head>
<body class="bg-gray-100 text-gray-800 transition-all duration-300">

  <!-- Modern Sidebar -->
  <aside id="sidebar" class="hidden md:flex flex-col fixed left-0 top-0 h-full w-64 bg-white shadow-xl p-6 z-50">
    <h2 class="text-2xl font-bold text-primary mb-6 flex items-center gap-2">ğŸ¾ PaseoDog</h2>
    <nav class="flex flex-col gap-3 text-gray-700 font-medium">
      <button onclick="showView('login-section')" class="text-left px-3 py-2 rounded-lg hover:bg-gray-100">Inicio</button>
      <button onclick="showView('admin-dashboard-section')" class="text-left px-3 py-2 rounded-lg hover:bg-gray-100">Panel Admin</button>
      <button onclick="showView('profile-section')" class="text-left px-3 py-2 rounded-lg hover:bg-gray-100">Perfil</button>
      <button onclick="showView('walks-history-section')" class="text-left px-3 py-2 rounded-lg hover:bg-gray-100">Historial</button>
    </nav>
  </aside>

  <!-- Mobile topbar -->
  <div class="md:hidden flex justify-between items-center p-4 bg-white shadow">
    <h1 class="font-bold text-xl text-primary flex items-center gap-1">ğŸ¾ PaseoDog</h1>
    <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="p-2">â˜°</button>
  </div>

  <div id="mobile-menu" class="hidden md:hidden bg-white p-4 shadow flex flex-col gap-3 absolute w-full z-40">
    <button onclick="showView('login-section')" class="text-left px-3 py-2 rounded-lg hover:bg-gray-100">Inicio</button>
    <button onclick="showView('admin-dashboard-section')" class="text-left px-3 py-2 rounded-lg hover:bg-gray-100">Panel Admin</button>
    <button onclick="showView('profile-section')" class="text-left px-3 py-2 rounded-lg hover:bg-gray-100">Perfil</button>
    <button onclick="showView('walks-history-section')" class="text-left px-3 py-2 rounded-lg hover:bg-gray-100">Historial</button>
  </div>

  <!-- Main content wrapper shifted for sidebar -->
  <div class="md:ml-64 transition-all duration-300">
  <a class="skip-link" href="#app">Saltar al contenido</a>
  <div class="site">
    <header>
      <div class="brand">
        <h1>ğŸ¾ PaseoDog</h1>
        <p id="saludo-usuario">GestiÃ³n Profesional de Paseos</p>
      </div>
      <div class="controls">
        <button id="theme-toggle" aria-label="Cambiar tema">ğŸ•â€ğŸ¦º</button>
      </div>
    </header>

    <main id="app" class="app" role="main">

      <!-- LOADING OVERLAY -->
      <div id="loading-overlay" style="display:flex">
        <div class="spinner" aria-hidden="true"></div>
        <p style="color:#fff">Cargando base de datos...</p>
      </div>

      <!-- ====== LOGIN ====== -->
      <section id="login-section" class="grid cards" aria-labelledby="login-title">
        <h2 id="login-title">ğŸ” Acceso al Sistema</h2>
        <form id="login-form" novalidate>
          <label for="email">Correo ElectrÃ³nico</label>
          <input type="email" id="email" placeholder="ejemplo@paseos.com" required>

          <label for="password">ContraseÃ±a</label>
          <div class="password-wrapper">
            <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required aria-describedby="password-help">
            <button type="button" class="password-toggle" id="toggle-password" aria-label="Mostrar contraseÃ±a">ğŸ‘ï¸</button>
          </div>

          <button type="submit" class="btn-primary">Iniciar SesiÃ³n</button>
          <p id="error-message" class="error" style="display:none;margin-top:8px;"></p>

          <div class="info-text" style="margin-top:12px;">
            <strong>ğŸ”‘ Credenciales de prueba:</strong>
            <div style="margin-top:8px">
              ğŸ‘¨â€ğŸ’¼ <strong>Admin:</strong> <code>admin@paseos.com</code> / <code>admin123</code><br>
              ğŸ‘¤ <strong>Clientes (pass: 123456):</strong>
              <ul style="margin-left:14px;margin-top:6px">
                <li><code>cliente@paseos.com</code> (Fido)</li>
                <li><code>luna@paseos.com</code> (Luna)</li>
                <li><code>max@paseos.com</code> (Max)</li>
              </ul>
            </div>
          </div>

          <button type="button" id="toggle-demo-btn" class="btn-ghost" style="margin-top:10px;">ğŸ­ Resetear Base de Datos</button>

          <p id="demo-status" style="text-align:center;margin-top:12px;color:var(--muted)">Estado: <strong id="demo-status-text" style="color:var(--primary)">Base de datos cargada</strong></p>
        </form>
      </section>

      <!-- ====== ADMIN DASHBOARD ====== -->
      <section id="admin-dashboard-section" class="grid cards" style="display:none;">
        <h2>ğŸ‘¨â€ğŸ’¼ Panel de Administrador</h2>
        <button class="btn-primary add-dog-btn" onclick="showView('create-dog-section')">â• Registrar Nuevo Mimoso</button>
        <p style="color:var(--muted);margin-top:8px">Lista de perros registrados:</p>
        <div id="dog-list-container"></div>
      </section>

      <!-- ====== CREATE DOG ====== -->
      <section id="create-dog-section" class="grid cards" style="display:none;">
        <h2>ğŸ¶ Registrar Nuevo Mimoso</h2>
        <form id="create-dog-form">
          <h3>Datos del Perro</h3>
          <label>Nombre</label><input type="text" id="new-dog-name" required>
          <label>Raza</label><input type="text" id="new-dog-breed" required>
          <label>Sexo</label><select id="new-dog-sex"><option>Macho</option><option>Hembra</option></select>

          <h3>Datos del DueÃ±o</h3>
          <label>Nombre DueÃ±o</label><input type="text" id="new-dog-owner" required>
          <label>Email (Usuario)</label><input type="email" id="new-dog-email" required>
          <label>TelÃ©fono (WhatsApp)</label><input type="tel" id="new-dog-phone" required>

          <button type="submit" class="btn-primary save-btn">ğŸ’¾ Guardar en Base de Datos</button>
        </form>
        <button class="btn-ghost" onclick="goBack()">Cancelar</button>
      </section>

      <!-- ====== DOG DASHBOARD ====== -->
      <section id="dog-selection-dashboard" class="grid cards" style="display:none;">
        <h2>ğŸ• Dashboard de <span class="dog-name-placeholder"></span></h2>

        <div id="carousel-wrapper" style="display:none;">
          <div id="carousel-container" style="width:100%;height:100%">
            <img id="carousel-img" src="" alt="Diapositiva">
            <div class="carousel-controls">
              <button class="carousel-btn" onclick="prevSlide()">â—€</button>
              <div style="display:flex;gap:8px;align-items:center">
                <button class="carousel-btn" id="play-pause-btn" onclick="togglePlay()">â–¶ï¸</button>
                <button class="carousel-btn" onclick="toggleFullscreen()">â›¶</button>
              </div>
              <span id="carousel-counter">0 / 0</span>
              <button class="carousel-btn" onclick="nextSlide()">â–¶</button>
            </div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:18px">
          <button id="admin-create-walk-btn" class="btn-danger" style="display:none;" onclick="showView('create-walk-section')">â• Crear Nuevo Paseo</button>
          <button class="btn-secondary" onclick="showView('walks-history-section')">ğŸ“œ Historial de Paseos</button>
          <button class="btn-ghost" onclick="showView('profile-section')">ğŸ“‹ Ver/Editar Perfil</button>
        </div>

        <button class="btn-ghost" onclick="goBack()" style="margin-top:12px">â¬…ï¸ Volver</button>
      </section>

      <!-- ====== CREATE WALK ====== -->
      <section id="create-walk-section" class="grid cards" style="display:none;">
        <h2>â• Crear Nuevo Paseo</h2>
        <form id="walk-form">
          <div style="background:var(--glass);padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);margin-bottom:12px">
            <label style="color:var(--accent)">ğŸ¶ Â¿QuiÃ©n mÃ¡s vino al paseo?</label>
            <div id="multi-dog-container"></div>
          </div>

          <label>ğŸ“… Fecha</label><input type="date" id="walk-date" required>
          <label>â±ï¸ DuraciÃ³n (min)</label><input type="number" id="walk-duration" value="60" required>
          <label>ğŸ“ Distancia (km)</label><input type="number" id="walk-distance" step="0.1" value="3.5">
          <label>ğŸ“ Resumen</label><textarea id="walk-summary" required></textarea>

          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <input type="checkbox" id="comportamiento-problemas">
            <label for="comportamiento-problemas">âš ï¸ Problemas de comportamiento</label>
          </div>

          <label>ğŸ©º Notas de Salud</label><textarea id="incidentes-salud"></textarea>

          <h3>ğŸ“¸ Fotos del Paseo</h3>
          <div id="photo-preview" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px"></div>
          <button type="button" id="simulate-photos-btn" class="btn-secondary">ğŸ“· Simular Fotos</button>
          <button type="submit" class="btn-primary" style="margin-top:12px">ğŸ’¾ Guardar Paseo</button>
        </form>
        <button class="btn-ghost" onclick="goBack()">Cancelar</button>
      </section>

      <!-- ====== PROFILE ====== -->
      <section id="profile-section" class="grid cards" style="display:none;">
        <h2>ğŸ“‹ Perfil Completo</h2>
        <div id="profile-content">
          <div id="profile-photo-container">
            <img id="profile-photo" src="" alt="Foto del Perro">
            <p id="profile-dog-name-display" class="dog-name-placeholder" style="font-weight:800;color:var(--primary);margin-top:10px;font-size:1.1rem"></p>
            <button id="edit-photo-btn" class="btn-ghost" style="display:none;margin:10px auto" onclick="randomizeProfilePhoto()">ğŸ² Cambiar Foto</button>
            <button id="toggle-edit-btn" class="btn-secondary" style="display:block;margin-top:12px" onclick="toggleEditMode()">âœï¸ Editar Perfil</button>
          </div>

          <div id="profile-details-view"></div>
          <form id="profile-details-edit" style="display:none"></form>
        </div>
        <button class="btn-ghost" onclick="goBack()">â¬…ï¸ Volver</button>
      </section>

      <!-- ====== HISTORY ====== -->
      <section id="walks-history-section" class="grid cards" style="display:none;">
        <h2>ğŸ“œ Historial de Paseos</h2>
        <div id="walks-history"></div>
        <button class="btn-ghost" onclick="goBack()">â¬…ï¸ Volver</button>
      </section>

    </main>

    <!-- LIGHTBOX -->
    <div id="lightbox" aria-hidden="true">
      <div class="modal-content">
        <button id="close-lightbox" aria-label="Cerrar" style="float:right;background:transparent;border:none;font-size:22px">&times;</button>
        <img id="lightbox-img" src="" style="width:100%;border-radius:10px">
      </div>
    </div>

    <!-- MODAL EDIT WALK -->
    <div id="edit-walk-modal" aria-hidden="true">
      <div class="modal-content">
        <h2>âœï¸ Editar Paseo</h2>
        <form id="edit-walk-form">
          <label>Fecha</label><input type="date" id="edit-walk-date">
          <label>DuraciÃ³n</label><input type="number" id="edit-walk-duration">
          <label>Distancia</label><input type="number" id="edit-walk-distance" step="0.1">
          <label>Resumen</label><textarea id="edit-walk-summary"></textarea>
          <div style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="edit-walk-behavior"><label for="edit-walk-behavior">Problemas</label></div>
          <label>Salud</label><textarea id="edit-walk-health"></textarea>

          <h3>Gestionar Fotos</h3>
          <div id="edit-photo-preview" style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0"></div>
          <button type="button" onclick="addPhotoEdit()" class="btn-secondary" style="width:100%;margin-bottom:10px">â• Agregar Foto</button>

          <div style="display:flex;gap:10px">
            <button type="submit" class="btn-primary">Guardar</button>
            <button type="button" onclick="document.getElementById('edit-walk-modal').style.display='none'" class="btn-ghost">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- FLOAT WHATSAPP -->
    <a href="#" id="whatsapp-btn" class="whatsapp-float" target="_blank" style="display:none" aria-label="Abrir WhatsApp">
      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.017-1.04 2.481 0 1.461 1.063 2.875 1.211 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
    </a>

  </div>

  <script>
    // ====== CONFIG ======
    const DB_KEY = 'paseoDogDB_EXTERNAL';
    const DB_URL = 'paseoDogDB.json';
    let DATABASE = null; let MOCK_DOGS = []; let TRAINER_PHONE = "5491100000000";
    let ADMIN_USER = { email: 'admin@paseos.com', password: 'admin123' };

    // ====== STATE ======
    let currentUser=null, currentDog=null, currentView='login-section';
    let simulatedPhotos=[], tempPhotoId=null, isEditing=false; let backStack=[];
    let editWalkIdx=null, editWalkPhotos=[]; let slideInterval=null, isPlaying=false;

    // ====== HELPERS ======
    function $(id){return document.getElementById(id)}
    function qs(sel){return document.querySelector(sel)}

    function getPhotoUrl(id,w=400,h=400){
      return `https://images.unsplash.com/photo-${id}?auto=format&fit=crop&w=${w}&h=${h}&q=80`;
    }

    async function loadExternalDB(){
      try{const res=await fetch(DB_URL); if(!res.ok) throw new Error('No se pudo cargar DB'); DATABASE=await res.json(); MOCK_DOGS=DATABASE.dogs; TRAINER_PHONE=DATABASE.trainer_phone; ADMIN_USER=DATABASE.admin; return true}catch(e){console.warn(e); return false}
    }

    function loadDB(){const data=localStorage.getItem(DB_KEY); return data?JSON.parse(data):MOCK_DOGS}
    function saveDB(data){localStorage.setItem(DB_KEY,JSON.stringify(data)); MOCK_DOGS=data}

    // ====== THEME ======
    const themeToggle=$('theme-toggle'); function updateThemeIcon(){const isDark=document.documentElement.getAttribute('data-theme')==='dark'; themeToggle.textContent=isDark?'ğŸ©':'ğŸ•â€ğŸ¦º'}
    themeToggle.onclick=()=>{const cur=document.documentElement.getAttribute('data-theme'); document.documentElement.setAttribute('data-theme',cur==='dark'?'light':'dark'); updateThemeIcon()}

    // ====== WHATSAPP ======
    function updateWhatsApp(){const btn=$('whatsapp-btn'); if(currentView.includes('login')||currentView.includes('admin-dashboard')){btn.style.display='none';return} btn.style.display='flex'; let num=TRAINER_PHONE; if(currentUser && currentUser.isAdmin && currentDog) num=currentDog.perfil.telefono.replace(/[^0-9]/g,''); btn.href=`https://wa.me/${num}`}

    // ====== NAV ======
    function showView(id,dogId=null){ MOCK_DOGS=loadDB(); if(id!==currentView) backStack.push(currentView); currentView=id; document.querySelectorAll('main > section').forEach(s=>s.style.display='none'); const el=$(id); if(el) el.style.display='block'; if(dogId) currentDog=MOCK_DOGS.find(d=>d.id===dogId); if(currentDog){ document.querySelectorAll('.dog-name-placeholder').forEach(e=>e.textContent=currentDog.nombre); if(id==='dog-selection-dashboard') { $('admin-create-walk-btn').style.display = currentUser && currentUser.isAdmin ? 'block' : 'none'; initCarousel(); } if(id==='profile-section'){ isEditing=false; loadProfile(currentDog); } if(id==='walks-history-section') loadHistory(currentDog); if(id==='create-walk-section'){ document.getElementById('walk-form').reset(); document.getElementById('walk-date').valueAsDate=new Date(); simulatedPhotos=[]; $('photo-preview').innerHTML=''; loadMultiDog(); } }
      if(id==='admin-dashboard-section') loadAdminDashboard(); updateWhatsApp(); window.scrollTo({top:0,behavior:'smooth'});
    }
    function goBack(){ if(backStack.length) showView(backStack.pop()); else showView('login-section') }

    // ====== LOGIN ======
    $('toggle-password').onclick=()=>{ const p=$('password'); p.type = p.type==='password'?'text':'password' }
    $('login-form').addEventListener('submit',e=>{ e.preventDefault(); const em=$('email').value.toLowerCase(); const pw=$('password').value; MOCK_DOGS=loadDB(); if(em===ADMIN_USER.email && pw===ADMIN_USER.password){ currentUser={email:em,isAdmin:true}; showView('admin-dashboard-section'); } else { const d=MOCK_DOGS.find(x=>x.dueno_email===em); if(d && pw==='123456'){ currentUser={email:em,isAdmin:false}; currentDog=d; showView('dog-selection-dashboard'); } else { $('error-message').style.display='block'; $('error-message').textContent='âŒ Credenciales incorrectas' } } })

    // ====== ADMIN ======
    function loadAdminDashboard(){ const c=$('dog-list-container'); c.innerHTML=''; $('demo-status-text').textContent = `${MOCK_DOGS.length} perros en BD`; if(!MOCK_DOGS.length) return c.innerHTML='<p class="info-text">Sin perros.</p>'; MOCK_DOGS.forEach(d=>{ const div=document.createElement('div'); div.className='dog-card'; div.innerHTML=`<div><span>ğŸ¶ <strong>${d.nombre}</strong> <small style="color:var(--muted)">(${d.perfil.raza})</small></span></div><div><button class="btn-primary" onclick="showView('dog-selection-dashboard',${d.id})">Gestionar</button></div>`; c.appendChild(div) }) }

    // ====== CREATE DOG ======
    $('create-dog-form').addEventListener('submit',e=>{ e.preventDefault(); const newId = MOCK_DOGS.length?Math.max(...MOCK_DOGS.map(d=>d.id))+1:1; const nd = { id:newId, nombre:$('new-dog-name').value, dueno_email:$('new-dog-email').value, perfil:{ raza:$('new-dog-breed').value, sexo:$('new-dog-sex').value, dueno:$('new-dog-owner').value, telefono:$('new-dog-phone').value, foto_id: DATABASE?.photo_references?.random?.[0] || '1583335768497-8a9f6d0f9f6f', edad:'?', peso:'?', alergias:'Ninguna', energia:'Media', social:'?' }, walks:[] }; MOCK_DOGS.push(nd); saveDB(MOCK_DOGS); alert('âœ… Perro registrado'); showView('admin-dashboard-section') })

    // ====== PROFILE ======
    function loadProfile(d){ const p=d.perfil; $('profile-photo').src = getPhotoUrl(tempPhotoId || p.foto_id,300,300); $('profile-dog-name-display').textContent = d.nombre; $('edit-photo-btn').style.display = isEditing ? 'block':'none'; $('toggle-edit-btn').textContent = isEditing? 'âŒ Cancelar':'âœï¸ Editar Perfil'; const v=$('profile-details-view'); const e=$('profile-details-edit'); v.innerHTML = `\n      <h3>ğŸ• Datos BÃ¡sicos</h3>\n      <div class="detail-row"><strong style="color:var(--muted);min-width:120px;display:inline-block">Raza:</strong> ${p.raza}</div>\n      <div class="detail-row" style="margin-top:6px"><strong style="color:var(--muted);min-width:120px;display:inline-block">Edad:</strong> ${p.edad}</div>\n      <div class="detail-row" style="margin-top:6px"><strong style="color:var(--muted);min-width:120px;display:inline-block">Sexo:</strong> ${p.sexo}</div>\n      <h3 style=\"margin-top:10px\">ğŸ’Š Salud y Contacto</h3>\n      <div class="detail-row" style="margin-top:6px"><strong style="color:var(--muted);min-width:120px;display:inline-block">Peso:</strong> ${p.peso}</div>\n      <div class="detail-row" style="margin-top:6px"><strong style="color:var(--muted);min-width:120px;display:inline-block">Alergias:</strong> ${p.alergias}</div>\n      <div class="detail-row" style="margin-top:6px"><strong style="color:var(--muted);min-width:120px;display:inline-block">DueÃ±o:</strong> ${p.dueno}</div>\n      <div class="detail-row" style="margin-top:6px"><strong style="color:var(--muted);min-width:120px;display:inline-block">TelÃ©fono:</strong> ${p.telefono}</div>\n      <h3 style=\"margin-top:10px\">ğŸ¾ Comportamiento</h3>\n      <div class="detail-row" style="margin-top:6px"><strong style="color:var(--muted);min-width:120px;display:inline-block">EnergÃ­a:</strong> ${p.energia}</div>\n      <div class="detail-row" style="margin-top:6px"><strong style="color:var(--muted);min-width:120px;display:inline-block">Social:</strong> ${p.social}</div>`; e.innerHTML=''; const fields=['raza','edad','sexo','peso','alergias','dueno','telefono','energia','social']; fields.forEach(k=> e.innerHTML+=`<label>${k.charAt(0).toUpperCase()+k.slice(1)}</label><input type="text" name="${k}" value="${p[k]}">`); e.innerHTML += '<button type="submit" class="btn-primary" style="margin-top:10px">Guardar Cambios</button>'; v.style.display = isEditing? 'none':'block'; e.style.display = isEditing? 'block':'none' }

    function toggleEditMode(){ isEditing = !isEditing; tempPhotoId=null; loadProfile(currentDog) }
    function randomizeProfilePhoto(){ tempPhotoId = DATABASE?.photo_references?.random?.[Math.floor(Math.random()* (DATABASE.photo_references.random.length || 1))]; $('profile-photo').src = getPhotoUrl(tempPhotoId,300,300) }
    $('profile-details-edit').addEventListener('submit',e=>{ e.preventDefault(); const fd=new FormData(e.target); const idx=MOCK_DOGS.findIndex(d=>d.id===currentDog.id); for(let [k,v] of fd.entries()) MOCK_DOGS[idx].perfil[k]=v; if(tempPhotoId) MOCK_DOGS[idx].perfil.foto_id=tempPhotoId; saveDB(MOCK_DOGS); isEditing=false; loadProfile(MOCK_DOGS[idx]) })

    // ====== CREATE WALK ======
    function loadMultiDog(){ const c=$('multi-dog-container'); c.innerHTML=''; MOCK_DOGS.filter(d=>d.id!==currentDog.id).forEach(d=>{ const wrap=document.createElement('div'); wrap.className='dog-select-item'; wrap.innerHTML=`<input type="checkbox" value="${d.id}" id="md${d.id}"><label for="md${d.id}" style="margin:0">${d.nombre}</label>`; c.appendChild(wrap) }) }

    $('simulate-photos-btn').onclick=()=>{ simulatedPhotos=[]; const c=$('photo-preview'); c.innerHTML=''; for(let i=0;i<3;i++){ const id = DATABASE?.photo_references?.random?.[i] || '1583335768497-8a9f6d0f9f6f'; simulatedPhotos.push({id,comentario:`Foto ${i+1} del paseo`}); const img=document.createElement('img'); img.src=getPhotoUrl(id,100,100); img.alt=`Foto ${i+1}`; img.style.width='100px'; img.style.height='100px'; img.style.objectFit='cover'; c.appendChild(img) } }

    $('walk-form').addEventListener('submit',e=>{ e.preventDefault(); const w={ fecha:$('walk-date').value, duracion_minutos:parseInt($('walk-duration').value), distancia_km:parseFloat($('walk-distance').value), resumen_diario:$('walk-summary').value, comportamiento_problemas:$('comportamiento-problemas').checked, incidentes_salud:$('incidentes-salud').value, fotos:simulatedPhotos }; const idx=MOCK_DOGS.findIndex(d=>d.id===currentDog.id); MOCK_DOGS[idx].walks.unshift(JSON.parse(JSON.stringify(w))); document.querySelectorAll('#multi-dog-container input:checked').forEach(cb=>{ const pIdx=MOCK_DOGS.findIndex(d=>d.id==cb.value); if(pIdx>-1) MOCK_DOGS[pIdx].walks.unshift(JSON.parse(JSON.stringify(w))) }); saveDB(MOCK_DOGS); alert('âœ… Paseo guardado!'); showView('dog-selection-dashboard') })

    // ====== HISTORY & EDIT ======
    function loadHistory(d){ const c=$('walks-history'); c.innerHTML=''; if(!d.walks.length) return c.innerHTML='<p class="info-text">Sin historial.</p>'; d.walks.forEach((w,i)=>{ const imgs = w.fotos.map(f=>`<div class="photo-card" onclick="openLightbox('${f.id}')"><img src="${getPhotoUrl(f.id,200,200)}" alt="Foto paseo"></div>`).join(''); const adminBtns = (currentUser && currentUser.isAdmin) ? `<div style="display:flex;gap:8px"><button class="btn-ghost" onclick="openEditWalk(${i})">âœï¸ Editar</button><button class="btn-ghost" style="border-color:#fca5a5;color:#ef4444" onclick="delWalk(${i})">ğŸ—‘ï¸ Borrar</button></div>`: ''; c.innerHTML+=`<div class="walk-session" style="margin-bottom:14px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);overflow:hidden"><h3 style="background:linear-gradient(135deg,var(--primary),var(--primary-600));color:#fff;padding:12px;margin:0;display:flex;justify-content:space-between;align-items:center">ğŸ“… ${w.fecha} ${adminBtns}</h3><div style="padding:12px"><div style="display:flex;gap:8px;margin:8px 0"><span class="cards">â±ï¸ ${w.duracion_minutos} min</span><span class="cards">ğŸ“ ${w.distancia_km} km</span><span class="cards">ğŸ“¸ ${w.fotos.length} fotos</span></div><p><strong>Resumen:</strong> ${w.resumen_diario}</p>${w.comportamiento_problemas?'<div class="incident-alert">âš ï¸ Hubo problemas de comportamiento</div>':'<div class="success-notice">âœ… Paseo tranquilo</div>'}${w.incidentes_salud?`<div class="incident-alert">ğŸ©º <strong>Salud:</strong> ${w.incidentes_salud}</div>`:''}<div class="gallery" style="margin-top:8px">${imgs}</div></div></div>` }) }

    function openEditWalk(i){ editWalkIdx=i; editWalkPhotos=[...currentDog.walks[i].fotos]; const w=currentDog.walks[i]; $('edit-walk-date').value=w.fecha; $('edit-walk-duration').value=w.duracion_minutos; $('edit-walk-distance').value=w.distancia_km; $('edit-walk-summary').value=w.resumen_diario; $('edit-walk-behavior').checked=w.comportamiento_problemas; $('edit-walk-health').value=w.incidentes_salud; renderEditPhotos(); $('edit-walk-modal').style.display='flex' }
    function renderEditPhotos(){ const c=$('edit-photo-preview'); c.innerHTML=''; editWalkPhotos.forEach((p,i)=>{ const wrap=document.createElement('div'); wrap.style.position='relative'; wrap.innerHTML=`<img src="${getPhotoUrl(p.id,100,100)}" style="width:100px;height:100px;object-fit:cover;border-radius:8px"><button type="button" class="delete-photo-btn" style="position:absolute;top:6px;right:6px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer" onclick="delEditPhoto(${i})">x</button>`; c.appendChild(wrap) }) }
    function delEditPhoto(i){ editWalkPhotos.splice(i,1); renderEditPhotos() }
    function addPhotoEdit(){ editWalkPhotos.push({ id: DATABASE?.photo_references?.random?.[0] || '1583335768497-8a9f6d0f9f6f', comentario: 'Nueva foto' }); renderEditPhotos() }
    $('edit-walk-form').addEventListener('submit',e=>{ e.preventDefault(); const idx=MOCK_DOGS.findIndex(d=>d.id===currentDog.id); MOCK_DOGS[idx].walks[editWalkIdx] = { fecha:$('edit-walk-date').value, duracion_minutos:parseInt($('edit-walk-duration').value), distancia_km:parseFloat($('edit-walk-distance').value), resumen_diario:$('edit-walk-summary').value, comportamiento_problemas:$('edit-walk-behavior').checked, incidentes_salud:$('edit-walk-health').value, fotos: editWalkPhotos }; saveDB(MOCK_DOGS); $('edit-walk-modal').style.display='none'; loadHistory(MOCK_DOGS[idx]) })
    function delWalk(i){ if(confirm('Â¿Borrar este paseo?')){ const idx=MOCK_DOGS.findIndex(d=>d.id===currentDog.id); MOCK_DOGS[idx].walks.splice(i,1); saveDB(MOCK_DOGS); loadHistory(MOCK_DOGS[idx]) } }

    // ====== LIGHTBOX ======
    function openLightbox(id){ $('lightbox-img').src = getPhotoUrl(id,800,800); $('lightbox').style.display='flex' }
    $('close-lightbox').onclick=()=> $('lightbox').style.display='none'

    // ====== CAROUSEL ======
    function initCarousel(){ const w=$('carousel-wrapper'); const slides=[]; if(currentDog.walks) currentDog.walks.forEach(wa=> wa.fotos && wa.fotos.forEach(f=> slides.push(f.id))); if(!slides.length){ w.style.display='none'; return } w.style.display='flex'; let idx=0; const img=$('carousel-img'); const cnt=$('carousel-counter'); const show=()=>{ img.style.opacity=0; setTimeout(()=>{ img.src=getPhotoUrl(slides[idx],1200,800); img.onload=()=> img.style.opacity=1; cnt.textContent=`${idx+1}/${slides.length}`; },180) }; show(); window.nextSlide=()=>{ idx=(idx+1)%slides.length; show() }; window.prevSlide=()=>{ idx=(idx-1+slides.length)%slides.length; show() }; window.togglePlay=()=>{ const b=$('play-pause-btn'); if(isPlaying){ clearInterval(slideInterval); b.textContent='â–¶ï¸'; isPlaying=false } else { nextSlide(); slideInterval=setInterval(nextSlide,3200); b.textContent='â¸ï¸'; isPlaying=true } }; window.toggleFullscreen=()=>{ const el=$('carousel-container'); !document.fullscreenElement? el.requestFullscreen():document.exitFullscreen() }
    }

    // ====== RESET DB ======
    $('toggle-demo-btn').onclick=async()=>{ if(confirm('Â¿Resetear base de datos con datos originales?')){ $('loading-overlay').style.display='flex'; await loadExternalDB(); localStorage.removeItem(DB_KEY); MOCK_DOGS = DATABASE?.dogs || []; saveDB(MOCK_DOGS); $('loading-overlay').style.display='none'; alert('âœ… Base de datos reseteada'); location.reload() } }

    // ====== INIT ======
    window.onload = async ()=>{ $('loading-overlay').style.display='flex'; const loaded = await loadExternalDB(); if(loaded){ const localData = localStorage.getItem(DB_KEY); if(localData) MOCK_DOGS = JSON.parse(localData); else { MOCK_DOGS = DATABASE.dogs || []; saveDB(MOCK_DOGS) } } $('loading-overlay').style.display='none'; showView('login-section'); updateThemeIcon() }

  </script>
</body>
</html>
